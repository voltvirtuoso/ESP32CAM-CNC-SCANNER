<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' content='width=device-width,initial-scale=1'/>
		<title>ESP32-CAM GRBL</title>
<style>
:root {
  --bg-primary: #1e1e1e;
  --bg-secondary: #2d2d2d;
  --bg-tertiary: #3d3d3d;
  --text-primary: #e0e0e0;
  --text-secondary: #a0a0a0;
  --accent-primary: #4dabf7;
  --accent-secondary: #9c36b5;
  --success: #51cf66;
  --warning: #ffd43b;
  --danger: #ff6b6b;
  --border-radius: 8px;
  --box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  display: flex;
  min-height: 100vh;
}
.container {
  display: flex;
  width: 100%;
  flex: 1;
}
.sidebar {
  width: 250px;
  background-color: var(--bg-secondary);
  padding: 20px 0;
  box-shadow: var(--box-shadow);
  z-index: 100;
  display: flex;
  flex-direction: column;
}
.sidebar-header {
  padding: 0 20px 20px;
  border-bottom: 1px solid var(--bg-tertiary);
  margin-bottom: 20px;
}
.sidebar-menu {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.menu-item {
  padding: 12px 20px;
  color: var(--text-primary);
  text-decoration: none;
  background: transparent;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}
.menu-item:hover {
  background-color: var(--bg-tertiary);
}
.menu-item.active {
  background-color: var(--bg-tertiary);
  border-left: 3px solid var(--accent-primary);
}
.main-content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--bg-tertiary);
}
.header h1 {
  margin: 0;
  font-size: 24px;
}
.content-section {
  background-color: var(--bg-secondary);
  border-radius: var(--border-radius);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--box-shadow);
}
.feed-container {
  width: 100%;
  text-align: center;
  margin-bottom: 20px;
}
.camera-feed {
  width: 100%;
  max-width: 600px;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin: 0 auto;
  display: block;
}
.controls-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.control-group {
  background-color: var(--bg-tertiary);
  border-radius: var(--border-radius);
  padding: 15px;
}
.control-group h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: var(--accent-primary);
  border-bottom: 1px solid var(--bg-secondary);
  padding-bottom: 8px;
}
.axis-controls {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}
.btn {
  padding: 12px;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: bold;
  font-size: 16px;
}
.x-btn { background: linear-gradient(to bottom, #ff6b6b, #d32f2f); color: white; }
.y-btn { background: linear-gradient(to bottom, #4ecdc4, #26a69a); color: white; }
.z-btn { background: linear-gradient(to bottom, #4dabf7, #2196f3); color: white; }
.home-btn { background: linear-gradient(to bottom, #ffd43b, #f9c22e); color: #333; }
.stop-btn { background: linear-gradient(to bottom, #ff6b6b, #d32f2f); color: white; }
.reset-btn { background: linear-gradient(to bottom, #51cf66, #37b24d); color: white; }
.scan-btn { background: linear-gradient(to bottom, #9c36b5, #7b2cbf); color: white; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 15px;
}
.form-group {
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: var(--text-secondary);
}
.form-group input,
.form-group select {
  width: 100%;
  padding: 10px;
  border-radius: var(--border-radius);
  border: 1px solid var(--bg-tertiary);
  background-color: var(--bg-primary);
  color: var(--text-primary);
  box-sizing: border-box;
}
.scan-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}
.scan-progress {
  width: 100%;
  height: 20px;
  background-color: var(--bg-primary);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
}
.scan-progress-bar {
  height: 100%;
  background: linear-gradient(to right, #4ecdc4, #26a69a);
  width: 0%;
  transition: width 0.3s;
}
.scan-status {
  margin-top: 10px;
  font-weight: bold;
  color: var(--warning);
  text-align: center;
}
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}
.status-item {
  background-color: var(--bg-primary);
  padding: 12px;
  border-radius: var(--border-radius);
  border-left: 4px solid var(--accent-primary);
}
.status-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}
.status-value {
  font-weight: bold;
  color: var(--warning);
  font-size: 16px;
}
.settings-content {
  display: none;
}
.settings-content.active {
  display: block;
}
@media (max-width: 768px) {
  .container {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    height: auto;
  }
  .axis-controls {
    grid-template-columns: repeat(3, 1fr);
  }
  .controls-grid {
    grid-template-columns: 1fr;
  }
  .scan-controls {
    grid-template-columns: 1fr;
  }
}
</style>
	</head>
	<body>
    <div class="container">
      <!-- Sidebar Menu -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>ESP32-CAM GRBL</h2>
        </div>
        <div class="sidebar-menu">
          <button class="menu-item active" data-target="main">Main Controls</button>
          <button class="menu-item" data-target="camera">Camera Settings</button>
          <button class="menu-item" data-target="motion">Motion Settings</button>
          <button class="menu-item" data-target="scan">Scan Settings</button>
          <button class="menu-item" data-target="system">System Info</button>
          <button class="menu-item" data-target="files">File Browser</button>
        </div>
      </div>
      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1>CNC Controller</h1>
          <div>IP: <span id="ipAddress">--</span></div>
        </div>
        <!-- Main Controls Section -->
        <div id="main" class="settings-content active">
          <!-- System Status -->
          <div class="content-section">
            <h3>System Status</h3>
            <div class="status-grid">
              <div class="status-item">
                <div class="status-label">Machine State</div>
                <div class="status-value" id="state">--</div>
              </div>
              <div class="status-item">
                <div class="status-label">Position</div>
                <div class="status-value" id="pos">X:-- Y:-- Z:--</div>
              </div>
              <div class="status-item">
                <div class="status-label">Last Command</div>
                <div class="status-value" id="last">None</div>
              </div>
              <div class="status-item">
                <div class="status-label">Response</div>
                <div class="status-value" id="resp">--</div>
              </div>
            </div>
          </div>
          <!-- Camera Feed -->
          <div class="feed-container">
            <img id="stream" class="camera-feed" alt="Camera Feed"/>
          </div>
          <!-- Motion Controls -->
          <div class="content-section">
            <h3>Motion Control</h3>
            <div class="axis-controls">
              <button class="btn y-btn" onclick="jog('Y','+')">Y+</button>
              <button class="btn z-btn" onclick="jog('Z','+')">Z+</button>
              <button class="btn y-btn" onclick="jog('Y','-')">Y-</button>
              <button class="btn x-btn" onclick="jog('X','-')">X-</button>
              <button class="btn stop-btn" id="stopResumeBtn" onclick="toggleStopResume()">STOP</button>
              <button class="btn x-btn" onclick="jog('X','+')">X+</button>
              <button class="btn z-btn" onclick="jog('Z','-')">Z-</button>
            </div>
            <div class="form-group">
              <label>Step Size (mm):</label>
              <select id="stepSize">
                <option value="0.1">0.1 mm</option>
                <option value="1" selected>1 mm</option>
                <option value="5">5 mm</option>
                <option value="10">10 mm</option>
                <option value="50">50 mm</option>
                <option value="100">100 mm</option>
              </select>
            </div>
            <div class="form-group">
              <label>Feed Rate (mm/min):</label>
              <input type="number" id="feedRate" value="1000" min="10" max="5000" step="100">
            </div>
            <div class="quick-actions">
              <button class="btn reset-btn" onclick="resetZero('all')">Zero All</button>
              <button class="btn reset-btn" onclick="resetZero('X')">Zero X</button>
              <button class="btn reset-btn" onclick="resetZero('Y')">Zero Y</button>
              <button class="btn reset-btn" onclick="resetZero('Z')">Zero Z</button>
              <button class="btn home-btn" onclick="unlock()">Unlock</button>
              <button class="btn home-btn" onclick="getStatus()">Status</button>
            </div>
          </div>
          <!-- Saved Points -->
          <div class="content-section">
            <h3>Saved Points</h3>
            <div class="form-group">
              <label>Point Name:</label>
              <input type="text" id="pointName" placeholder="e.g., Home, Corner A">
            </div>
            <button class="btn home-btn" onclick="saveCurrentPoint()">Save Current Position</button>
            <div id="savedPointsList" style="margin-top:15px;"></div>
          </div>
          <!-- Spatial Scan -->
          <div class="content-section">
            <h3>Spatial Scan</h3>
            <div class="scan-controls">
              <div class="form-group">
                <label>X Start (mm):</label>
                <input type="number" id="scanXStart" value="0" step="0.1">
              </div>
              <div class="form-group">
                <label>X End (mm):</label>
                <input type="number" id="scanXEnd" value="100" step="0.1">
              </div>
              <div class="form-group">
                <label>Y Start (mm):</label>
                <input type="number" id="scanYStart" value="0" step="0.1">
              </div>
              <div class="form-group">
                <label>Y End (mm):</label>
                <input type="number" id="scanYEnd" value="100" step="0.1">
              </div>
              <div class="form-group">
                <label>Step Size (mm):</label>
                <input type="number" id="scanStep" value="5" step="0.1">
              </div>
              <div class="form-group">
                <label>Scan Feed Rate (mm/min):</label>
                <input type="number" id="scanFeedRate" value="150" min="10" max="1000" step="10">
              </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:15px">
              <button class="btn scan-btn" onclick="startScan()">Start Scan</button>
              <button class="btn stop-btn" onclick="stopScan()">Stop/Resume Scan</button>
            </div>
            <div class="scan-progress">
              <div id="scanProgressBar" class="scan-progress-bar"></div>
            </div>
            <div class="scan-status" id="scanStatus">Ready</div>
          </div>
        </div>
        <!-- Camera Settings Section -->
        <div id="camera" class="settings-content">
          <div class="content-section">
            <h3>Camera Settings</h3>
            <div class="controls-grid">
              <div class="control-group">
                <h3>Resolution</h3>
                <div class="form-group">
                  <label>Select Resolution:</label>
                  <select id="resolution" onchange="setResolution()">
                    <option value="3">QVGA (320x240)</option>
                    <option value="5">VGA (640x480)</option>
                    <option value="6" selected>SVGA (800x600)</option>
                    <option value="7">XGA (1024x768)</option>
                    <option value="8">HD (1280x720)</option>
                    <option value="10">UXGA (1600x1200)</option>
                  </select>
                </div>
              </div>
              <div class="control-group">
                <h3>Quality</h3>
                <div class="form-group">
                  <label>Quality: <span id="qval">10</span></label>
                  <input type="range" min="5" max="63" value="10" id="quality" oninput="setQuality(this.value)">
                </div>
              </div>
              <div class="control-group">
                <h3>Brightness</h3>
                <div class="form-group">
                  <label>Brightness: <span id="bval">0</span></label>
                  <input type="range" min="-2" max="2" value="0" id="brightness" oninput="setBrightness(this.value)">
                </div>
              </div>
              <div class="control-group">
                <h3>Contrast</h3>
                <div class="form-group">
                  <label>Contrast: <span id="cval">0</span></label>
                  <input type="range" min="-2" max="2" value="0" id="contrast" oninput="setContrast(this.value)">
                </div>
              </div>
              <div class="control-group">
                <h3>Flip Options</h3>
                <div style="display:flex;gap:10px;margin-top:10px">
                  <button class="btn home-btn" onclick="toggleFlip('h')">H-Flip</button>
                  <button class="btn home-btn" onclick="toggleFlip('v')">V-Flip</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Motion Settings Section -->
        <div id="motion" class="settings-content">
          <div class="content-section">
            <h3>Motion Settings</h3>
            <div class="controls-grid">
              <div class="control-group">
                <h3>Default Feed Rates</h3>
                <div class="form-group">
                  <label>Default Feed Rate (mm/min):</label>
                  <input type="number" id="defaultFeedRate" value="1000" min="10" max="5000" step="100" onchange="updateDefaultFeedRate()">
                </div>
              </div>
              <div class="control-group">
                <h3>Step Increments</h3>
                <div class="form-group">
                  <label>Small Step (mm):</label>
                  <input type="number" id="smallStep" value="0.1" min="0.01" max="1" step="0.01">
                </div>
                <div class="form-group">
                  <label>Large Step (mm):</label>
                  <input type="number" id="largeStep" value="10" min="1" max="100" step="1">
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scan Settings Section -->
        <div id="scan" class="settings-content">
          <div class="content-section">
            <h3>Scan Settings</h3>
            <div class="controls-grid">
              <div class="control-group">
                <h3>Scan Parameters</h3>
                <div class="form-group">
                  <label>Default Scan Feed Rate (mm/min):</label>
                  <input type="number" id="defaultScanFeedRate" value="150" min="10" max="1000" step="10">
                </div>
                <div class="form-group">
                  <label>Default Step Size (mm):</label>
                  <input type="number" id="defaultStepSize" value="5" min="0.1" max="20" step="0.1">
                </div>
              </div>
              <div class="control-group">
                <h3>Scan Limits</h3>
                <div class="form-group">
                  <label>Max Scan Area X (mm):</label>
                  <input type="number" id="maxScanX" value="200" min="10" max="1000" step="10">
                </div>
                <div class="form-group">
                  <label>Max Scan Area Y (mm):</label>
                  <input type="number" id="maxScanY" value="200" min="10" max="1000" step="10">
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- System Info Section -->
        <div id="system" class="settings-content">
          <div class="content-section">
            <h3>System Information</h3>
            <div class="status-grid">
              <div class="status-item">
                <div class="status-label">Firmware Version</div>
                <div class="status-value">v1.0.0</div>
              </div>
              <div class="status-item">
                <div class="status-label">ESP32 Core</div>
                <div class="status-value">FreeRTOS</div>
              </div>
              <div class="status-item">
                <div class="status-label">Uptime</div>
                <div class="status-value" id="uptime">--</div>
              </div>
              <div class="status-item">
                <div class="status-label">WiFi Signal</div>
                <div class="status-value" id="wifiSignal">-- dBm</div>
              </div>
              <div class="status-item">
                <div class="status-label">CPU Usage</div>
                <div class="status-value" id="cpuUsage">--%</div>
              </div>
              <div class="status-item">
                <div class="status-label">Memory</div>
                <div class="status-value" id="memory">--%</div>
              </div>
            </div>
          </div>
        </div>
        <!-- File Browser Section -->
        <div id="files" class="settings-content">
          <div class="content-section">
            <h3>File Browser</h3>
            <div id="fileList"></div>
          </div>
        </div>
      </div>
    </div>
		<script>
			let hflip=0,vflip=0;
      let currentMenu = 'main';
      // Set camera stream URL
      document.getElementById('stream').src=window.location.protocol+'//'+window.location.hostname+':81/stream';
      // Get IP address
      fetch('/ip').then(r => r.text()).then(ip => {
        document.getElementById('ipAddress').textContent = ip;
      });
      // Menu navigation
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          const target = item.getAttribute('data-target');
          document.querySelectorAll('.settings-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(target).classList.add('active');
          currentMenu = target;
            if (target === 'files') {
            loadFiles();
          }
        });
      });
			function api(endpoint,params=''){
				const url=endpoint+(params?'?'+params:'');
				return fetch(url).then(r=>r.text()).catch(e=>{console.error(e);return'ERROR';});
			}
			function jog(axis,dir){
				const step=document.getElementById('stepSize').value;
				const feed=document.getElementById('feedRate').value;
				const cmd='G21G91G1'+axis+dir+step+'F'+feed;
				send(cmd);
			}
			function unlock(){send('$X');}
			function toggleStopResume() {
        const btn = document.getElementById('stopResumeBtn');
        if (isStopped) {
          // Resume operation
          send('~'); // GRBL cycle resume command
          btn.textContent = 'STOP';
          btn.classList.remove('home-btn');
          btn.classList.add('stop-btn');
          isStopped = false;
          
          // If we were scanning, resume the scan
          if(document.getElementById('scanStatus').textContent.includes('paused')) {
            api('/resumescan').then(resp => {
              if(resp === 'OK') {
                document.getElementById('scanStatus').textContent = 'Scanning...';
              }
            });
          }
        } else {
          // Stop/hold operation
          send('!'); // GRBL feed hold command
          btn.textContent = 'RESUME';
          btn.classList.remove('stop-btn');
          btn.classList.add('home-btn');
          isStopped = true;
          
          // If we're scanning, stop both machine and recording
          if(document.getElementById('scanStatus').textContent.includes('Scanning')) {
            stopScan();
          }
        }
      }
			function resetZero(axis){
				if(axis==='all'){
					send('G10 L20 P0 X0 Y0 Z0');
				}else{
					send('G10 L20 P0 '+axis+'0');
				}
				setTimeout(getStatus,500);
			}
function saveCurrentPoint() {
  const name = document.getElementById('pointName').value.trim();
  if (!name) {
    alert('Please enter a point name');
    return;
  }
  api('/savepoint', 'name=' + encodeURIComponent(name)).then(resp => {
    if (resp === 'OK') {
      alert('Point saved!');
      loadSavedPoints();
    } else {
      alert('Error: ' + resp);
    }
  });
}
function loadSavedPoints() {
  api('/getpoints').then(data => {
    try {
      const points = JSON.parse(data);
      let html = '';
      if (points.length === 0) {
        html = '<p>No saved points.</p>';
      } else {
        points.forEach(pt => {
          html += `
            <div style="display:flex;gap:8px;margin:5px 0;align-items:center;">
              <span><strong>${pt.name}</strong>: X${pt.x} Y${pt.y} Z${pt.z}</span>
              <button class="btn x-btn" style="padding:6px 10px;font-size:14px;" onclick="goToPoint('${pt.name}')">Go</button>
              <button class="btn stop-btn" style="padding:6px 10px;font-size:14px;" onclick="deletePoint('${pt.name}')">Delete</button>
            </div>`;
        });
      }
      document.getElementById('savedPointsList').innerHTML = html;
    } catch(e) {
      console.error(e);
      document.getElementById('savedPointsList').innerHTML = '<p>Error loading points</p>';
    }
  });
}
function deletePoint(name) {
  if (!confirm(`Delete point "${name}"? This cannot be undone.`)) return;
  api('/deletepoint', 'name=' + encodeURIComponent(name)).then(resp => {
    if (resp === 'OK') {
      alert('Point deleted');
      loadSavedPoints();
    } else {
      alert('Error: ' + resp);
    }
  });
}
function goToPoint(name) {
  if (!confirm(`Move to point "${name}"?`)) return;
  api('/gotopoint', 'name=' + encodeURIComponent(name)).then(resp => {
    if (resp === 'OK') {
      alert('Moving to point');
      getStatus();
    } else {
      alert('Error: ' + resp);
    }
  });
}
function updateDefaultFeedRate() {
  const newRate = document.getElementById('defaultFeedRate').value;
  defaultFeedRate = newRate;
  api('/setdefaultfeed', 'rate=' + newRate).then(resp => {
    if (resp === 'OK') {
      alert('Default feed rate updated');
    }
  });
}
			function preset(cmd){send(cmd);}
			function send(cmd){
				document.getElementById('last').textContent=cmd;
				document.getElementById('state').textContent='Sending...';
				api('/cmd','c='+encodeURIComponent(cmd)).then(resp=>{
					document.getElementById('resp').textContent=resp;
					setTimeout(getStatus,300);
				});
			}
			function sendGcode(){
				const v=document.getElementById('gcodeInput').value.trim();
				if(v){send(v);document.getElementById('gcodeInput').value='';}
			}
			function getStatus(){
				api('/status').then(data=>{
					try{
						const d=JSON.parse(data);
						document.getElementById('state').textContent=d.state||'--';
						document.getElementById('pos').textContent=d.position||'--';
					}catch(e){console.error(e);}
				});
			}
			function setResolution(){
				const v=document.getElementById('resolution').value;
				api('/camera','res='+v);
			}
			function setQuality(v){
				document.getElementById('qval').textContent=v;
				api('/camera','quality='+v);
			}
			function setBrightness(v){
				document.getElementById('bval').textContent=v;
				api('/camera','brightness='+v);
			}
			function setContrast(v){
				document.getElementById('cval').textContent=v;
				api('/camera','contrast='+v);
			}
			function toggleFlip(type){
				if(type==='h'){
					hflip=1-hflip;
					api('/camera','hmirror='+hflip);
				}else{
					vflip=1-vflip;
					api('/camera','vflip='+vflip);
				}
			}
			function startScan(){
				const xStart = document.getElementById('scanXStart').value;
				const xEnd = document.getElementById('scanXEnd').value;
				const yStart = document.getElementById('scanYStart').value;
				const yEnd = document.getElementById('scanYEnd').value;
				const step = document.getElementById('scanStep').value;
				const feed = document.getElementById('scanFeedRate').value;  // Use scan-specific feedrate
				api('/startscan',`xstart=${xStart}&xend=${xEnd}&ystart=${yStart}&yend=${yEnd}&step=${step}&feed=${feed}`)
				.then(resp => {
					if(resp === 'OK'){
						document.getElementById('scanStatus').textContent = 'Scanning...';
					} else {
						document.getElementById('scanStatus').textContent = 'Error: ' + resp;
					}
				});
			}
			function stopScan(){
        // Send feed hold to GRBL to stop machine movement
        if (isStopped) {
          // Resume scan
          send('~');
          isStopped = false;
          document.getElementById('stopResumeBtn').textContent = 'STOP';
          document.getElementById('stopResumeBtn').classList.remove('home-btn');
          document.getElementById('stopResumeBtn').classList.add('stop-btn');
          
          api('/resumescan').then(resp => {
            if(resp === 'OK'){
              document.getElementById('scanStatus').textContent = 'Scanning...';
            } else {
              document.getElementById('scanStatus').textContent = 'Error: ' + resp;
            }
          });
        } else {
          // Stop scan
          send('!');
          isStopped = true;
          document.getElementById('stopResumeBtn').textContent = 'RESUME';
          document.getElementById('stopResumeBtn').classList.remove('stop-btn');
          document.getElementById('stopResumeBtn').classList.add('home-btn');
          
          api('/stopscan').then(resp => {
            if(resp === 'OK'){
              document.getElementById('scanStatus').textContent = 'Scan paused';
            } else {
              document.getElementById('scanStatus').textContent = 'Error: ' + resp;
            }
          });
        }
			}
			function updateScanStatus(){
				api('/scanstatus').then(data => {
					try {
						const d = JSON.parse(data);
						document.getElementById('scanStatus').textContent = d.status;
						document.getElementById('scanProgressBar').style.width = d.progress + '%';
					} catch(e) {
						console.error(e);
					}
				});
			}
      // Update system info
      function updateSystemInfo() {
        api('/systeminfo').then(data => {
          try {
            const info = JSON.parse(data);
            document.getElementById('uptime').textContent = info.uptime;
            document.getElementById('wifiSignal').textContent = info.wifiSignal + ' dBm';
            document.getElementById('cpuUsage').textContent = info.cpuUsage + '%';
            document.getElementById('memory').textContent = info.memory + '%';
          } catch(e) {
            console.error(e);
          }
        });
      }
			setInterval(getStatus,2000);
			setInterval(updateScanStatus, 500);
      setInterval(updateSystemInfo, 5000);
			window.onload=function(){
        console.log('Ready');
        getStatus();
        updateSystemInfo();
        loadSavedPoints(); 
      };
      function loadFiles(dir = '/') {
        const url = '/files' + (dir !== '/' ? '?dir=' + encodeURIComponent(dir) : '');
        fetch(url)
          .then(r => r.json())
          .then(data => {
            let html = '';
            // Parent folder
            if (data.parent) {
              const pf = (data.parent.lastIndexOf('/') > 0) ? data.parent.substring(0, data.parent.lastIndexOf('/')) : '/';
              html += `<button class="btn home-btn" style="display:block;margin:1px 0 1px;text-decoration:none" onclick="loadFiles('${pf}')">..</button><br>`;
            }
            // Folders
            data.folders.forEach(folder => {
              const folderName = '/' + folder;    // Hard coded for now
              html += `<div style="display:flex;align-items:center;gap:5px;margin:5px 0;">
                <button class="btn home-btn" style="flex:1" onclick="loadFiles('${folder}')">${folder}</button>
                <button class="btn stop-btn" style="padding:10px 10px;" onclick="deleteFolder('${folderName}')">Delete</button>
              </div>`;
            });
            // Files
            data.files.forEach(file => {
              const name = file.split('/').pop();
              const fullPath = data.parent + '/' + file;
              html += `<a href="/download?file=${encodeURIComponent(fullPath)}" class="btn scan-btn" style="display:block;margin:5px 0;text-decoration:none" download="${name}">${name}</a>`;
            });
            if (data.folders.length === 0 && data.files.length === 0) {
              html = '<p>No files found.</p>';
            }
            document.getElementById('fileList').innerHTML = html;
          })
          .catch(err => {
            document.getElementById('fileList').innerHTML = '<p>Error loading files.</p>';
            console.error(err);
          });
      }
      // Delete folder function
      function deleteFolder(folder) {
        if (confirm(`Are you sure you want to delete "${folder}"? This cannot be undone.`)) {
          fetch(`/deletefolder?folder=${encodeURIComponent(folder)}`)
            .then(r => r.text())
            .then(msg => {
              alert(msg);
              loadFiles(); // Refresh list
            })
            .catch(err => {
              alert('Error deleting folder');
              console.error(err);
            });
        }
      }
		</script>
	</body>
</html>
